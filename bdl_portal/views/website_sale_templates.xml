<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="assets_frontend" name="bdl address assets" inherit_id="website.assets_frontend">
        <xpath expr="." position="inside">
            <script type="text/javascript" src="/bdl_portal/static/src/js/website_sale_address.js"></script>
        </xpath>
    </template>

    <template id="product_configurator_configure_optional_products_bdl"
              inherit_id="sale.product_configurator_configure_optional_products">
        <xpath expr="//tr[@t-if='product.optional_product_ids']" position="before">
            <t t-set="valid_products" t-value="set()"/>
            <t t-if="not product.env.user.has_group('base.group_user')">
                <t t-set="pricelist_id" t-value="product.env.user.partner_id.property_product_pricelist"/>
                <t t-set="valid_products" t-value="pricelist_id.get_related_product_tmpl_ids()"/>
            </t>
        </xpath>

        <xpath expr="//tr[@t-if='product.optional_product_ids']" position="attributes">
            <attribute name="t-if">product.optional_product_ids and (any([p for p in product.optional_product_ids if
                p.id in valid_products]) if valid_products else True)
            </attribute>
        </xpath>
    </template>


    <template id="optional_product_items_bdl" inherit_id="sale.optional_product_items">
        <xpath expr="//t[@t-if='product._is_add_to_cart_possible(parent_combination)']" position="attributes">
            <attribute name="t-if">product._is_add_to_cart_possible(parent_combination) and (product.id in
                valid_products if valid_products else True)
            </attribute>
        </xpath>
    </template>

    <template id="payment_bdl" inherit_id="website_sale.payment">

        <xpath expr="//div[@id='shipping_and_billing']/a" position="attributes">
            <attribute name="groups">bdl_portal.group_portal_admin,base.group_user,base.group_public</attribute>
        </xpath>

        <xpath expr="//t[@t-set='same_shipping']" position="attributes">
            <attribute name="t-value">bool(order.partner_shipping_id==order.partner_invoice_id or only_services) if
                order.partner_invoice_id else bool(order.partner_shipping_id==order.partner_id or only_services)
            </attribute>
        </xpath>

        <xpath expr="//span[@t-esc='order.partner_id']" position="attributes">
            <attribute name="t-esc">order.partner_invoice_id or order.partner_id</attribute>
        </xpath>

    </template>

    <template id="address_kanban_bdl" inherit_id="website_sale.address_kanban">

        <!-- modify the entire card body and footer part -->

        <xpath expr="//div[1]" position="replace">
            <t t-if="not is_bill">

                <div t-attf-class="card #{selected and 'border_primary' or 'js_change_shipping'}">
                    <div class='card-body' style='min-height: 130px;'>
                        <a t-if="not actual_partner or (ship.id in actual_partner.child_ids.ids)"
                           groups="bdl_portal.group_portal_admin,base.group_user,base.group_public" href="#"
                           class="btn btn-link float-right p-0 js_edit_address no-decoration" role="button"
                           title="Edit this address" aria-label="Edit this address">
                            <i class='fa fa-edit'/>
                        </a>
                        <t t-esc="contact"
                           t-options="dict(widget='contact', fields=['name', 'address'], no_marker=True)"/>
                    </div>

                    <div class='card-footer' t-if='not readonly'>

                        <span class='btn-ship' t-att-style="'' if selected else 'display:none;'">
                            <a role="button" href='#' class="btn btn-block btn-primary">
                                <i class='fa fa-check'></i>
                                Ship to this address
                            </a>
                        </span>
                        <span class='btn-ship' t-att-style="'' if not selected else 'display:none;'">
                            <a role="button" href='#' class="btn btn-block btn-secondary">
                                Select this address
                            </a>
                        </span>
                    </div>
                </div>

            </t>

            <t t-if="is_bill">

                <div t-attf-class="card #{selected and 'border_primary' or 'js_change_billing'}">
                    <div class='card-body' style='min-height: 130px;'>
                        <a t-if="not actual_partner or actual_partner or (bill.id in actual_partner.child_ids.ids)"
                           groups="bdl_portal.group_portal_admin,base.group_user,base.group_public" href="#"
                           class="btn btn-link float-right p-0 js_add_billing no-decoration" role="button"
                           title="Edit this address" aria-label="Edit this address">
                            <i class='fa fa-edit'/>
                        </a>
                        <t t-esc="contact"
                           t-options="dict(widget='contact', fields=['name', 'address'], no_marker=True)"/>
                    </div>

                    <div class='card-footer' t-if='not readonly'>
                        <span class='btn-bill' t-att-style="'' if selected else 'display:none;'">
                            <a role="button" href='#' class="btn btn-block btn-primary">
                                <i class='fa fa-check'></i>
                                Bill to this address
                            </a>
                        </span>
                        <span class='btn-bill' t-att-style="'' if not selected else 'display:none;'">
                            <a role="button" href='#' class="btn btn-block btn-secondary">
                                Select this address
                            </a>
                        </span>

                    </div>
                </div>

            </t>

        </xpath>
    </template>

    <template id="address_bdl" inherit_id="website_sale.address">
        <xpath expr="//h2[hasclass('o_page_header')][1]/.." position="before">
            <t t-if="mode == ('add', 'billing')">
                <h2 class="o_page_header mt8">Billing Address</h2>
            </t>
        </xpath>
        <xpath expr="//t[@t-if='partner_id == website_sale_order.partner_shipping_id.id == website_sale_order.partner_invoice_id.id']"
               position="attributes">
            <attribute name="t-if">partner_id == website_sale_order.partner_shipping_id.id</attribute>
        </xpath>

        <xpath expr="//input[@name='callback']" position="after">
            <input type="hidden" name="add_billing" t-att-value="add_billing or 0"/>
        </xpath>
    </template>

    <template id="checkout_bdl" inherit_id="website_sale.checkout">

        <xpath expr="//div[hasclass('all_shipping')][1]/div[1]/div[1]/div[1]/form[1]" position="attributes">
            <attribute name="groups">bdl_portal.group_portal_admin,base.group_user,base.group_public</attribute>
        </xpath>

        <!-- <xpath expr="//t[@t-if='not only_services']/../div[1]/div[1]" position="replace"/> -->


        <xpath expr="//t[@t-if='not only_services']/../div[1]" position="replace">
            <div class="row">
                <div class="col-lg-12">
                    <h3 class="o_page_header mt8">Billing Address</h3>
                </div>
            </div>
            <div class="row all_billing">
                <div class="col-lg-12">
                    <div class="row mt8">
                        <div class="col-md-12 col-lg-12">
                            <form action="/shop/address_add_billing" method="post" class=''
                                  groups="bdl_portal.group_portal_admin,base.group_user,base.group_public">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <a role="button" href="#" class='a-submit btn btn-secondary mb16 btn-block'>
                                    <i class="fa fa-plus-square"/>
                                    <span>Add an address</span>
                                </a>
                            </form>
                        </div>


                        <!--                        <ul class="list-unstyled">-->
                        <!--                            <t t-foreach="billings" t-as="bill"-->
                        <!--                               class="custom-control custom-radio">-->
                        <!--                                <li class="form-group">-->
                        <!--                                    <div class="radio_input_value">-->
                        <!--                                        <input type="radio" name="bill"/>-->
                        <!--                                        <label label-default="label-default">-->
                        <!--                                            &lt;!&ndash;                                <span t-esc="bill" t-options="dict(widget='contact', fields=['name', 'address'], no_marker=True)"/>&ndash;&gt;-->
                        <!--                                            <span t-esc="bill"/>-->
                        <!--                                        </label>-->
                        <!--                                    </div>-->
                        <!--                                </li>-->

                        <!--                            </t>-->
                        <!--                        </ul>-->
                        <!-- Code replacing kanban view to list view-->
                        <div class="radio_input_value col-md-12 col-lg-12">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th/>
                                        <th>Name</th>
                                        <th>Address</th>
                                        <th/>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="billings" t-as="bill">
                                        <t t-set='bill_selected' t-value="order.partner_invoice_id==bill"/>
                                        <tr class="one_list_row">
                                            <td>
                                                <t t-if="bill_selected">
                                                    <input type="radio" name="bill" checked="True"/>
                                                </t>
                                                <t t-else="">
                                                    <input type="radio" name="bill"/>
                                                </t>
                                            </td>
                                            <td>
                                                <t t-esc="bill.name"/>
                                            </td>
                                            <td>
                                                <t t-esc="bill"
                                                   t-options="dict(widget='contact', fields=['address'], no_marker=True)"/>
                                            </td>
                                            <td class="one_list">
                                                <form action="/shop/checkout" method="POST" class="d-none">
                                                    <input type="hidden" name="csrf_token"
                                                           t-att-value="request.csrf_token()"/>
                                                    <input type="hidden" name="partner_id" t-att-value="bill.id"/>

                                                    <input type="hidden" name="callback"
                                                           value="/shop/checkout?use_billing"/>
                                                    <input type='submit'/>
                                                </form>
                                                <a t-if="not order.partner_id or (bill.id in order.partner_id.child_ids.ids)"
                                                   href="#"
                                                   class="btn btn-link float-right p-0 js_edit_billing_list no-decoration"
                                                   role="button" title="Edit this address"
                                                   aria-label="Edit this address">
                                                    <i class='fa fa-edit'/>
                                                </a>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>


                        <!--                        <t t-foreach="billings" t-as="bill">-->
                        <!--                            <div class="col-md-12 col-lg-6 one_kanban">-->
                        <!--                                <t t-call="website_sale.address_kanban">-->
                        <!--                                    <t t-set="actual_partner" t-value="order.partner_id"/>-->
                        <!--                                    <t t-set='contact' t-value="bill"/>-->
                        <!--                                    <t t-set='is_bill' t-value="1"/>-->
                        <!--                                    <t t-set='selected' t-value="order.partner_invoice_id==bill"/>-->
                        <!--                                    <t t-set='readonly' t-value="bool(len(billings) == 1)"/>-->
                        <!--                                    &lt;!&ndash; <t t-set='edit_billing' t-value="bool(ship==order.partner_id)"/> &ndash;&gt;-->
                        <!--                                </t>-->
                        <!--                            </div>-->
                        <!--                        </t>-->

                    </div>
                </div>
            </div>
        </xpath>

        <xpath expr="//t[@t-if='not only_services']//t[@t-foreach='shippings']" position="replace">
            <div class="radio_input_value col-md-12 col-lg-12">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th/>
                            <th>Name</th>
                            <th>Address</th>
                            <th/>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="shippings" t-as="ship">
                            <t t-set='ship_selected' t-value="order.partner_shipping_id==ship"/>
                            <tr class="one_list_row">
                                <td>
                                    <t t-if="ship_selected">
                                        <input type="radio" name="ship" checked="True"/>
                                    </t>
                                    <t t-else="">
                                        <input type="radio" name="ship"/>
                                    </t>
                                </td>
                                <td>
                                    <t t-esc="ship.name"/>
                                </td>
                                <td>
                                    <t t-esc="ship"
                                       t-options="dict(widget='contact', fields=['address'], no_marker=True)"/>
                                </td>
                                <td class="one_list">
                                    <form action="/shop/checkout" method="POST" class="d-none">
                                        <input type="hidden" name="csrf_token"
                                               t-att-value="request.csrf_token()"/>
                                        <input type="hidden" name="partner_id" t-att-value="ship.id"/>

                                        <input type="hidden" name="callback"
                                               value="/shop/checkout?use_billing"/>
                                        <input type='submit'/>
                                    </form>
                                    <a t-if="not order.partner_id or (ship.id in order.partner_id.child_ids.ids)"
                                       href="#"
                                       class="btn btn-link float-right p-0 js_edit_shipping_list no-decoration"
                                       role="button" title="Edit this address"
                                       aria-label="Edit this address">
                                        <i class='fa fa-edit'/>
                                    </a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </xpath>
    </template>

    <template id="extra_info_bdl" inherit_id="website_sale.extra_info">
        <xpath expr="//form/div[1]" position="before">
            <div class="form-group row form-field o_website_form_custom">
                <div class="col-lg-3 col-md-4 text-md-right">
                    <label class="col-form-label" for="shipping_instructions">Shipping Instructions</label>
                </div>
                <div class="col-lg-9 col-md-8">
                    <textarea class="form-control o_website_form_input" rows="8" name="shipping_instructions"/>
                </div>
            </div>
        </xpath>
    </template>

    <!--Template for list view of contacts-->
    <template id="list_contact">
        <address t-ignore="true" class="mb0" itemscope="itemscope" itemtype="http://schema.org/Organization">
            <div t-if="not (('name' in fields) or (address and 'address' in fields) or (city and 'city' in fields) or (mobile and 'mobile' in fields) or (website and 'website' in fields) or (email and 'email' in fields))"
                 class="css_non_editable_mode_hidden">
                --<span class="text-muted" t-esc="name"/>--
            </div>
            <t t-if="object.country_id.name_position != 'after'">
                <t t-call="base.contact_name"/>
            </t>
            <div itemprop="address" itemscope="itemscope" itemtype="http://schema.org/PostalAddress">
                <div t-if="address and 'address' in fields">
                    <i t-if="not options.get('no_marker')" class='fa fa-map-marker fa-fw' role="img"
                       aria-label="Address" title="Address"/>
                    <span itemprop="streetAddress"
                          t-raw="address.replace('\n', options.get('no_tag_br') and ', ' or ('&lt;br/&gt;%s' % ('' if options.get('no_marker') else '')))"/>
                </div>
                <div t-if="city and 'city' in fields">
                    <i t-if="not options.get('no_marker')" class='fa fa-map-marker fa-fw' role="img"
                       aria-label="Address" title="Address"/>
                    <span itemprop="addressLocality" t-esc="city"/>,
                    <span itemprop="addressCountry" t-esc="country_id"/>
                </div>
                <div t-if="phone and 'phone' in fields">
                    <i t-if="not options.get('no_marker') or options.get('phone_icons')" class='fa fa-phone fa-fw'
                       role="img" aria-label="Phone" title="Phone"/>
                    <span class="o_force_ltr" itemprop="telephone" t-esc="phone"/>
                </div>
                <div t-if="mobile and 'mobile' in fields">
                    <i t-if="not options.get('no_marker') or options.get('phone_icons')" class='fa fa-mobile fa-fw'
                       role="img" aria-label="Mobile" title="Mobile"/>
                    <span class="o_force_ltr" itemprop="telephone" t-esc="mobile"/>
                </div>
                <div t-if="fax and 'fax' in fields">
                    <i t-if="not options.get('no_marker') or options.get('phone_icons')" class='fa fa-fax fa-fw'
                       role="img" aria-label="Fax" title="Fax"/>
                    <span class="o_force_ltr" itemprop="faxNumber" t-esc="fax"/>
                </div>
                <div t-if="website and 'website' in fields">
                    <i t-if="not options.get('no_marker')" class='fa fa-globe' role="img" aria-label="Website"
                       title="Website"/>
                    <a t-att-href="website and '%s%s' % ('http://' if '://' not in website else '',website)">
                        <span itemprop="website" t-esc="website"/>
                    </a>
                </div>
                <div t-if="email and 'email' in fields">
                    <i t-if="not options.get('no_marker')" class='fa fa-envelope fa-fw' role="img" aria-label="Email"
                       title="Email"/>
                    <span itemprop="email" t-esc="email"/>
                </div>
            </div>
            <t t-if="object.country_id and object.country_id.name_position == 'after'">
                <t t-call="base.contact_name"/>
            </t>
        </address>
    </template>

    <!--List view for Address in checkout-->
    <template id="address_list_bdl" name="List Address">
        <form action="/shop/checkout" method="POST" class="d-none">
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            <input type="hidden" name="partner_id" t-att-value="contact.id"/>
            <t t-if='edit_billing'>
                <input type="hidden" name="callback" value="/shop/checkout?use_billing"/>
            </t>
            <input type='submit'/>
        </form>

        <div class="address_item">
            <ul>

            </ul>
        </div>

        <div t-attf-class="card #{selected and 'border_primary' or 'js_change_shipping'}">
            <div class='card-body' style='min-height: 130px;'>
                <a t-if="not actual_partner or (ship.id in actual_partner.child_ids.ids)" href="#"
                   class="btn btn-link float-right p-0 js_edit_address no-decoration" role="button"
                   title="Edit this address" aria-label="Edit this address">
                    <i class='fa fa-edit'/>
                </a>
                <t t-esc="contact" t-options="dict(widget='contact', fields=['name', 'address'], no_marker=True)"/>
            </div>
            <div class='card-footer' t-if='not readonly'>
                <span class='btn-ship' t-att-style="'' if selected else 'display:none;'">
                    <a role="button" href='#' class="btn btn-block btn-primary">
                        <i class='fa fa-check'></i>
                        Ship to this address
                    </a>
                </span>
                <span class='btn-ship' t-att-style="'' if not selected else 'display:none;'">
                    <a role="button" href='#' class="btn btn-block btn-secondary">
                        Select this address
                    </a>
                </span>
            </div>
        </div>
    </template>

</odoo>

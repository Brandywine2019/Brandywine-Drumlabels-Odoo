<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <template id="assets_frontend" name="bdl address assets" inherit_id="website.assets_frontend">
    <xpath expr="." position="inside">
      <script type="text/javascript" src="/bdl_portal/static/src/js/website_sale_address.js"></script>
    </xpath>
  </template>
  
  <template id="product_configurator_configure_optional_products_bdl" inherit_id="sale.product_configurator_configure_optional_products">
    <xpath expr="//tr[@t-if='product.optional_product_ids']" position="before">
      <t t-set="valid_products" t-value="set()"/>
      <t t-if="not product.env.user.has_group('base.group_user')">
  	<t t-set="pricelist_id" t-value="product.env.user.partner_id.property_product_pricelist"/>
  	<t t-set="valid_products" t-value="pricelist_id.get_related_product_tmpl_ids()"/>
      </t>
    </xpath>
    
    <xpath expr="//tr[@t-if='product.optional_product_ids']" position="attributes">
      <attribute name="t-if">product.optional_product_ids and (any([p for p in product.optional_product_ids if p.id in valid_products]) if valid_products else True) </attribute>
    </xpath>
  </template>


  <template id="optional_product_items_bdl" inherit_id="sale.optional_product_items">
    <xpath expr="//t[@t-if='product._is_add_to_cart_possible(parent_combination)']" position="attributes">
      <attribute name="t-if">product._is_add_to_cart_possible(parent_combination) and (product.id in valid_products if valid_products else True) </attribute>
    </xpath>
  </template>
  
   <template id="payment_bdl" inherit_id="website_sale.payment">
    
    <xpath expr="//div[@id='shipping_and_billing']/a" position="attributes">
      <attribute name="groups">bdl_portal.group_portal_admin,base.group_user,base.group_public</attribute>
    </xpath>

    <xpath expr="//t[@t-set='same_shipping']" position="attributes">
      <attribute name="t-value">bool(order.partner_shipping_id==order.partner_invoice_id or only_services) if order.partner_invoice_id else bool(order.partner_shipping_id==order.partner_id or only_services)</attribute>
    </xpath>
    
    <xpath expr="//span[@t-esc='order.partner_id']" position="attributes">
      <attribute name="t-esc">order.partner_invoice_id or order.partner_id</attribute>
    </xpath>
    
  </template>

  <template id="address_kanban_bdl" inherit_id="website_sale.address_kanban">

    <!-- modify the entire card body and footer part -->

    <xpath expr="//div[1]" position="replace">
      <t t-if="not is_bill">
	
      <div t-attf-class="card #{selected and 'border_primary' or 'js_change_shipping'}">
        <div class='card-body' style='min-height: 130px;'>
          <a t-if="not actual_partner or (ship.id in actual_partner.child_ids.ids)" groups="bdl_portal.group_portal_admin,base.group_user,base.group_public" href="#" class="btn btn-link float-right p-0 js_edit_address no-decoration" role="button" title="Edit this address" aria-label="Edit this address"><i class='fa fa-edit'/></a>
          <t t-esc="contact" t-options="dict(widget='contact', fields=['name', 'address'], no_marker=True)"/>
        </div>

	<div class='card-footer' t-if='not readonly'>

            <span class='btn-ship' t-att-style="'' if selected else 'display:none;'">
              <a role="button" href='#' class="btn btn-block btn-primary">
		<i class='fa fa-check'></i> Ship to this address
              </a>
            </span>
            <span class='btn-ship' t-att-style="'' if not selected else 'display:none;'">
              <a role="button" href='#' class="btn btn-block btn-secondary">
		Select this address
              </a>
            </span>
	</div>
      </div>

      </t>

      <t t-if="is_bill">
	
      <div t-attf-class="card #{selected and 'border_primary' or 'js_change_billing'}">
        <div class='card-body' style='min-height: 130px;'>
          <a t-if="not actual_partner or actual_partner or (bill.id in actual_partner.child_ids.ids)" groups="bdl_portal.group_portal_admin,base.group_user,base.group_public" href="#" class="btn btn-link float-right p-0 js_add_billing no-decoration" role="button" title="Edit this address" aria-label="Edit this address"><i class='fa fa-edit'/></a>
          <t t-esc="contact" t-options="dict(widget='contact', fields=['name', 'address'], no_marker=True)"/>
        </div>

	<div class='card-footer' t-if='not readonly'>
 	    <span class='btn-bill' t-att-style="'' if selected else 'display:none;'">
	      <a role="button" href='#' class="btn btn-block btn-primary">
		<i class='fa fa-check'></i> Bill to this address
	      </a>
	    </span>
	    <span class='btn-bill' t-att-style="'' if not selected else 'display:none;'">
	      <a role="button" href='#' class="btn btn-block btn-secondary">
		Select this address
	      </a>
	    </span>

	</div>
      </div>

      </t>

    </xpath>
  </template>

   <template id="address_bdl" inherit_id="website_sale.address">
     <xpath expr="//h2[hasclass('o_page_header')][1]/.." position="before">
       <t t-if="mode == ('add', 'billing')">
	 <h2 class="o_page_header mt8">Billing Address</h2>
       </t>
     </xpath>
     <xpath expr="//t[@t-if='partner_id == website_sale_order.partner_shipping_id.id == website_sale_order.partner_invoice_id.id']" position="attributes">
       <attribute name="t-if">partner_id == website_sale_order.partner_shipping_id.id</attribute>
     </xpath>
     
     <xpath expr="//input[@name='callback']" position="after">
      <input type="hidden" name="add_billing" t-att-value="add_billing or 0"/>
    </xpath>
  </template>
  
  <template id="checkout_bdl" inherit_id="website_sale.checkout">
    
    <xpath expr="//div[hasclass('all_shipping')][1]/div[1]/div[1]/div[1]/form[1]" position="attributes">
      <attribute name="groups">bdl_portal.group_portal_admin,base.group_user,base.group_public</attribute>
    </xpath>

    <!-- <xpath expr="//t[@t-if='not only_services']/../div[1]/div[1]" position="replace"/> -->


    <xpath expr="//t[@t-if='not only_services']/../div[1]" position="replace">
      <div class="row">
	<div class="col-lg-12">
	  <h3 class="o_page_header mt8">Billing Address</h3>
	</div>
      </div>
      <div class="row all_billing">
	<div class="col-lg-12">
	  <div class="row mt8">
	    <div class="col-md-12 col-lg-12">
	      <form action="/shop/address_add_billing" method="post" class='' groups="bdl_portal.group_portal_admin,base.group_user,base.group_public">
		<input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
		<a role="button" href="#" class='a-submit btn btn-secondary mb16 btn-block'>
		  <i class="fa fa-plus-square"/>
		  <span>Add an address</span>
		</a>
	      </form>
	    </div>
	    
            <t t-foreach="billings" t-as="bill">
	      <div class="col-md-12 col-lg-6 one_kanban">
	    	<t t-call="website_sale.address_kanban">
	    	  <t t-set="actual_partner" t-value="order.partner_id" />
	    	  <t t-set='contact' t-value="bill"/>
	    	  <t t-set='is_bill' t-value="1"/>
	    	  <t t-set='selected' t-value="order.partner_invoice_id==bill"/>
	    	  <t t-set='readonly' t-value="bool(len(billings) == 1)"/>
	    	  <!-- <t t-set='edit_billing' t-value="bool(ship==order.partner_id)"/> -->
	    	</t>
	      </div>
	    </t>
	    
	  </div>
	</div>
      </div>
    </xpath>
  </template>

  <template id="extra_info_bdl" inherit_id="website_sale.extra_info">
    <xpath expr="//form/div[1]" position="before">
      <div class="form-group row form-field o_website_form_custom">
	<div class="col-lg-3 col-md-4 text-md-right">
	  <label class="col-form-label" for="shipping_instructions">Shipping Instructions</label>
	</div>
	<div class="col-lg-9 col-md-8">
	  <textarea class="form-control o_website_form_input" rows="8" name="shipping_instructions"/>
	</div>
      </div>
    </xpath>
  </template>

</odoo>
